<!doctype html>
<!--ver 0.7.4.7-->
<html><head>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="robots" content="noindex,nofollow" />
<title>HD ESP32</title>
<script src="/jq.js" type="text/javascript"></script>
<style>
.center { text-align: center; }
.fl_l { float: left; }
.fl_r { float: right; }
.ta_l { text-align: left; }
.ta_r { text-align: right; }
.ta_c { text-align: center; }
.va_t { vertical-align: top; }
.va_m { vertical-align: middle; }
.va_b { vertical-align: bottom; }
.red { color: red; }
.bold { font-weight: bold; margin:0px;}

.ta_subtitle {
    font-weight: bold; 
    margin:0px;
    background-color:rgb(242, 242, 242);
    text-align: center;
}

:root {
  --text-color:#000000;
  --bgrd-color:#FFFFFF;
  --frame-brd-color: lightgray;
}

body, html {
 	margin: 0;
    padding: 0px;
    background-color: var(--bgrd-color);
    background: var(--bgrd-color);
	color: var(--text-color);
    font-family: Arial;
    line-height: 1.2em; 
    font-size: 14px;
}
select {font-size: 10pt;background-color: #dfdfdf; padding: 3px;}

img {border: 0; vertical-align: middle;}
h1 {
	color: var(--text-color); font-weight: bold; font-size: 16px;
        margin: 0; padding: 2px 0 3px 10px;
        background-position: 0 -2843px; background-repeat: repeat-x;
        border-top: 1px solid #f0f0f0; border-left: 1px solid #f0f0f0;
        border-right: 1px solid #f0f0f0; border-bottom: 1px solid #f0f0f0;
        vertical-align: middle; text-align: center;
}
h2, h3, h4 { text-align: center; font-weight: bold; color: var(--text-color); background-color: transparent; }
h3 {margin:0;}
.header { margin: 0px 0px 2px 0px; overflow: hidden; }
table.header {text-align: center; vertical-align: middle; 
	background-color: #dddddd; color: #990000; width: 100%;
	height: 55px; padding-left: 1px; padding-right: 1px;
	border-spacing: 3px; border-collapse: separate;
	margin-left:auto; margin-right:auto; margin-bottom: 5px;
}
table.header tr, table.header td, table.header th
{
	padding-left: 2px; padding-right: 2px;
        text-align: center; vertical-align: middle;
        background-color: #dddddd; color: #990000;
}
div.wrapper { text-align: left; float: left; width: 100%;}
div.content { margin-left: 5px; width: 1010px;}
div.footer {
	clear: left; padding-left: 15px; background: transparent;
	color: #990000; background-color: #dddddd; text-align: left;
	vertical-align: middle;
}
div.footer a { color: #990000; text-decoration: underline;}
li { padding-top: 3px;padding-bottom: 3px;}
ul li { list-style-type: square;}
input {padding: 5px;}
input.buttons {
        border: #3C3C3C 1px solid; font-family: Tahoma,verdana, Helvetica;
	font-size: 10pt; background-color: #D4D4D4; color: #404040;
}
.menu {
	margin-left: 10px;
	margin-top: 5px;
	padding: 5px;
}
.param {
        text-align: center;
        background-color: #404040;
        color: #000;
        padding-left: 1px;
        padding-right: 1px;
        border-spacing: 1px;
        border-collapse: separate;
        padding: 0;
/*        margin-left:auto;
        margin-right:auto;*/
}
.param tr {padding: 1px; background-color: #FFFFFF; color: #000;}

.stick {margin:15px; padding:15px; width:200px; }
.classic {border:1px solid #A7CD10; background-color:#E1FAB8; border-radius:15px; -webkit-border-radius:15px;}
.classic.error {border:1px solid #E2365C;background-color:#F7C8D2;}
.last {background-color:#CBECFA; border:1px solid #15A6E3;}
.exit{background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAACpElEQVR4nHWTTU8TQRzGn5n/rNtXuxVoWbSmJcYXwGQuFBNP+w0w8AEkPXHDT4LfoF7lAL6QXiDZIF4IlyXeCVEogqFu6Yvbmtnx4LIRo//jJL/fMzPPDEM0Xq22OvT9cvPjx6X5szMf/5gN27bsubm6Gg6PnjYaLwCAA8Cn5eV6YXZ2hTM2nxoddd+Mj1v/gV3r3r153WqtbD16VAcA5tVqq4XZ2ZXm1haGrRa0Uuien3v9dtt5dnrqA8D6xIRlV6tufnJSXuzuQisFAOj3ei/F0PfLze3tGIZSSOfzEmHorgMOGINdrbr5SkVe7OwASoFFuwqVKrO3xaKVHB110yMjEkpBhyGgFBCG6LbbXm5qCrcqFXnx4cPvda3BAFz2+16333cYALwZH7eSluWm83l5BbMwBMIQt548gb+3FyczreH3+143CJyFkxOf/XlJqWzWTd+8Ka9gpjX0YAAdBGBRclcI7zIInMWTEx9AfBwAwLptW6lMxs0kk1J9/w7VboMD4JyDiNAxDK8rhLN4fBzXLK51xRiylQpSponW4SEoAokIxDk4EfRf9fI/0wszM27asuTFzk6cSkQQRBBCoEgkRzh310ol65pgI4IzuZz81miAhyE4Y7FECAHDMGAIgdumKYuGEUvYhm1bY1HyeaMBrnWc2DNNj4hQIJJXAkMIEBE+B4F3HASOGJuerqdyOfl1cxNcazAiMMbQNQyvJ4SjARBj7p1IciMSPUgkJO906uJnp3N0urt7De6ZpvfDMOLbXiuVHKGUO0kkb0QSzjmSQXDEAOBdNls3BoPnRIRhOu0NTNNZiHq+mrVSybqTSrkP83mZTCTwpdd7dX9/fyl+B+9zuVUQlYeJxNJCs/nP7/z67l2rnMnUU4Zx9Pjg4AUA/ALA8B6CbeY2WQAAAABJRU5ErkJggg==) no-repeat; width:16px; height:16px; float:right; margin:-5px -5px 0 0; cursor:pointer}

.fpanel {
display:none;
height: 500px; /* высота нашего блока */
width: 350px; /* ширина нашего блока */
background: #fff; /* цвет фона, белый */
border: 1px solid #C1C1C1; /* размер и цвет границы блока */
overflow-x: scroll; /* прокрутка по горизонтали */
overflow-y: scroll; /* прокрутка по вертикали */
}

/*--------- переключатель-движок-------*/
/*
.switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 20px;
  margin-right: 2px;
}

.switch input {display:none;}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: gray;
  -webkit-transition: .1s;
  transition: .1s;
}
.slider:before {
  position: absolute;
  content: "";
  height: 14px;
  width: 14px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  -webkit-transition: .1s;
  transition: .1s;
}
input:checked + .slider {
  background-color: blue;
}

input:focus + .slider {
  box-shadow: 0 0 1px #2196F3;
}

input:checked + .slider:before {
  -webkit-transform: translateX(29px);
  -ms-transform: translateX(29px);
  transform: translateX(29px);
}

input[alt] {
  background-color: #0040ffe0;
  color: white;
  font-weight: bold;
}    

.slider.round {
  border-radius: 34px;
}

.slider.round:before {
  border-radius: 50%;
}
*/
/*-переключатель-движок->>*/
</style>

<script>
var Id;
var extColdConnected=0;

(function() {

  if (window.WebSocket) {
    return;
  } else if (window.MozWebSocket) {
    // Firefox.
    window.WebSocket = MozWebSocket;
    return;
  }
})();
geturlpath = function() {
  var pattern = "^(([^:/\\?#]+):)?(//(([^:/\\?#]*)(?::([^/\\?#]*))?))?([^\\?#]*)(\\?([^#]*))?(#(.*))?$";
  var rx = new RegExp(pattern);
  var parts = rx.exec(document.location.href);
//  var pathname = parts[7] || "/";
  return parts;
}
getUrlVar = function(key){
  var result = new RegExp(key + "=([^&]*)", "i").exec(window.location.search);
  return result && unescape(result[1]) || "";
}

ws_status = function(str,color) {
    $(".ws_status").html(str);
    let tcolor="white";
    let bcolor=color;
    
    if (color=="green"){
        tcolor="lightgreen";
        bcolor='green';
    }
    else if (color=="yellow"){
        tcolor="blue";
    }
    else if (color=="red"){
        tcolor="white";
    }
    $(".ws_status").css({'color':tcolor,'background-color': bcolor, });
}

infoUpdate = function(d){
	$(".time").html(d.time);
	$(".uptime").html(d.uptime);
	$(".MainStatusStr").html(d.MainStatusStr);
    putModeStat(d);
	$(".SetPower").html(d.SetPower);
    $(".SetPower").data("power", d.SetPower);
    
    if ($("#new_power").data("focused")==0) $("#new_power").val(d.SetPower);
        $(".CurPower").html(d.CurPower+' Вт');
        $(".CurVolts").html(d.CurVolts+' В');
        $(".CurFreq").html(d.CurFreq+' Гц');
        
	if (typeof(d.AlarmMode) != "undefined"){
        $(".AlarmMode").show();
        $(".AlarmMode").html(d.AlarmMode);
        $("#alarmStr").show();
    } 
    else {
        $(".AlarmMode").html("");
        $(".AlarmMode").hide();
    }
    
	$(".WaterOn").html(d.WaterOn);
	if (typeof(d.rect_t_stab) != "undefined") {
        if ($(".new_rect_t_stab").data("focused")==0) $(".new_rect_t_stab").val(d.rect_t_stab);
        $(".rect_t_stab").html(d.rect_t_stab);
		$(".rect_t_stab_i").show();
	} else {
		$(".rect_t_stab_i").hide();
	}
    
	if (typeof(d.rect_p_shim) != "undefined") {
		$(".rect_p_shim").html(d.rect_p_shim);
		$(".rect_p_shim_i").show();
	} else {
		$(".rect_p_shim_i").hide();
	}
    
	if (typeof(d.rect_time_stab) != "undefined") {
		$(".rect_time_stab").html(d.rect_time_stab);
		$(".rect_time_stab_i").show();
	} else  {
		$(".rect_time_stab_i").hide();
	}
	if (typeof(d.rect_timer1) != "undefined") {
		$(".rect_timer1").html(d.rect_timer1);
		$(".rect_timer1_i").show();
	} else  {
		$(".rect_timer1_i").hide();
	}
    
	if (eval(d.TempWaterIn)<0) $(".TempWaterIn").html("Нет данных");
	else $(".TempWaterIn").html(d.TempWaterIn);
	if (eval(d.TempWaterOut)<0) $(".TempWaterOut").html("Нет данных");
	else $(".TempWaterOut").html(d.TempWaterOut);
	if (eval(d.WaterFlow)<0) $(".WaterFlow").html("Нет данных");
	else $(".WaterFlow").html(d.WaterFlow);
	$(".heap").html('heap: '+d.heap);
    
    set_bmd_data(d);
    update_sensor_temp(d);
    display_valves(d.klapans);
}

create_sensor_table = function(d){
    var t = $('.temp_sensors');
    t.empty();
    for (var i in d.sensors) {
        var s = d.sensors[i];
        t.append('<tr><td>['+s.type_str+'] '+s.descr+'</td><td class="sens_'+s.id+' bold">'+s.temp+' C</td><tr>');
    }
}

update_sensor_temp=function(d){
    for (var i in d.sensors) {
        var s = d.sensors[i];
        var h = s.temp+' C';
        if (eval(s.temp)>=s.talert){
          $('.sens_'+s.id).css({'color':'white','background-color':'red'});
          h += ' [ALARM:'+ s.talert + ' C]';
        }
        else
          $('.sens_'+s.id).css({'color':'inherit','background-color': 'inherit'});
        
        $('.sens_'+s.id).html(h);
    }
}

var WS_SOCK;
var WS_address;
var WS_protocol;
function websock_init(address, protocol) {
  var error_try = 0;
  var ws_timeout;

  function ws_log(str) {
   $(".log").append(str+'<br />');
   $(".log").scrollTop(9999);
  }
  
  function ws_reconnect() {
    ws_status('TRY',"yellow");
    clearTimeout(ws_timeout);
    ws_timeout = null;
   WS_SOCK = new WebSocket(WS_address, WS_protocol);
  }
  
  WS_address = 'ws://'+address+'/ws';
  WS_protocol = protocol;
  ws_status('Init',"yellow");
  WS_SOCK = new WebSocket(WS_address, WS_protocol);

  WS_SOCK.onopen = function() {
    ws_status('OK',"green");
  };
  
  WS_SOCK.onmessage = function(e) {
    var d = jQuery.parseJSON(e.data);
    if ('undefined' == typeof d.cmd) return;
    
    time.text("0"); //reset the time of last WS message
    
    switch(d.cmd) {
    case 'logline':
        ws_log(d.ch+': '+d.level+' '+d.date+' '+d.message);
        break;
    case 'info':
        infoUpdate(d);
        if ((!alarm_sound_off) && (d.Alarm>0)) alarm_beep();
        break;
   case 'mode':
        $(".MainMode").val(d.MainMode);
        break;
   }
  };
  
  WS_SOCK.onclose = function() {
    ws_status('OFF',"red");
    setTimeout(ws_reconnect, 1000);
  };
  
  WS_SOCK.onerror = function() {
    ws_status('ERR',"red");
    setTimeout(ws_reconnect, 1000);
  };
}

// Copyright (C) 2010 recens Stikr, jQuery plugin
(function($) {
 $.stickr = function(o) {
 var o = $.extend({
  time:5000, speed:'slow', note:null, className:null,
  sticked:false, position:{top:0,right:0}
 }, o);

 var stickers = $('#jquery-stickers');
 if (!stickers.length) {
  $('body').prepend('<div id="jquery-stickers"></div>');
  var stickers = $('#jquery-stickers');
 }
 stickers.css('position','fixed').css({right:'auto',left:'auto',top:'auto',bottom:'auto'}).css(o.position);
 var stick = $('<div class="stick"></div>');
 stickers.append(stick);
 if (o.className) stick.addClass(o.className);
 stick.html(o.note);
 if (o.sticked) {
  var exit = $('<div class="exit"></div>');
  stick.prepend(exit);
  exit.click(function(){
    stick.fadeOut(o.speed,function(){
      $(this).remove();
    })
  });
 } else {
  setTimeout(function(){
   stick.fadeOut(o.speed,function(){
    $(this).remove();
   });
  }, o.time);
 }
 };
})(jQuery);

showStick = function(level,text) {
 if (level<0) $.stickr({note:'Ошибка.<br />'+text,className:'classic error',sticked:true});
 else $.stickr({note:text,className:'last',time:1000,speed:3000});

}

</script>
</head>
<body>
<div style="background-color: var(--bgrd-color); background: var(--bgrd-color); margin: 5px auto;">
<a id="top" accesskey="t"></a>
<table class="header" style="width: 100%;"><tbody>

<tr><td class="ta_l">
    <div class="ta_l">
        <a>WS:<span class="ws_status" style="background-color:red; border-radius:6px; padding-left:4px;padding-right:4px; width:40px;"></span> <span style="margin-left:6px;">(<a class="timeLastWS">6</a> сек.)</span></a> 
        <span class="AlarmMode bold"></span>
    </div>
<div class="ta_l"><span class="time"></span> up: <span class="uptime">0:0:0</span></div>
<div class="ta_l MainModeStr bold"></div>
<div class="ta_l bold"><span class="CurPower"></span>
<span class="bmpdata">
    <a>T:<span class="bmpTemperature"></span></a>
    <a>P:<span class="bmpTruePressure"></span></a>
</span>    
</div>
</td></tr>
<tr><td style="text-align: left; vertical-align: bottom; padding-top: 10px;">
<input class="menu" type="button" onClick="disp_main();" value="Главная"/>
<input class="menu" type="button" onClick="disp_network();" value="Настройки"/>
<input class="menu" type="button" onClick="disp_setting();" value="Параметры"/>
<input class="menu" type="button" onClick="disp_sensor();" value="Датчики"/>
<input class="menu" type="button" onClick="disp_wifi();" value="Wifi"/>
<input class="menu" type="button" onClick="disp_fs();" value="FS" />
<input class="menu" type="button" onClick="window.location.href='/update';" value="Обновления"/>
</td></tr></tbody></table>

<div class="wrapper"><div class="content" >

<div class="multiwin" style="display:flex">
<div style="text-align: left; overflow: auto; margin-bottom: 10px;">
<div class="pages" id="main_div" style="display: none;">
<table>
<tbody>
<tr><td>Режим: </td><td>
    <select class="MainMode" name="MainMode" id="new_mode">
        <option value="0">Мониторинг</option>
        <option value="1">Регулятор мощности</option>
        <option value="2">Дистилляция</option>
        <option value="3">Ректификация</option>
        <option value="10">Тестирование клапанов</option>
    </select>
    <input type="button" id="sw_mode" onclick="switch_mode();" value="Установить"/>
</td></tr>
<tr><td>Состояние: </td><td><span class="MainStatusStr bold"></span>
<input type="button" id="prev_status" onclick="prev_status();" value="Предыдущее"/>
<input type="button" id="next_status" onclick="next_status();" value="Следующее"/>

</td></tr>
<tr>
    <td>
    <div style="display:flex;align-items: center;">
    Авария:
        <!--<img src="pic1.png" height="30px" width="30px" style="margin-left:8px;margin-right:2px">-->
        <label class="switch" > <input id="alarmsound" type="checkbox"> <span class="slider"> </span>  </label>
        <img src="pic2.png" height="30px" width="30px" style="margin-right:12px">
    </div>
    </td>
    <td class="AlarmMode bold"></td>
</tr>
</tbody>
</table>

<table class="power">
<tbody>
<tr><td>Текущая мощность: </td><td class="CurPower bold"></td></tr>
<tr><td>Сеть: </td ><td class="bold"><span class="CurVolts"></span> <span class="CurFreq"></span></td></tr>
<tr><td>Заданая мощность: </td><td><span class="SetPower bold"></span> Вт
<input style="margin-left: 10px;" type="text" size="6" maxlength="8" name="new_power" id="new_power" />
<input class="menu" type="button" value="установить" onclick="setPower(0);" />
</td></tr>
<tr><td colspan="2" class="ta_l">
    <div>
    <input class="menu" type="button" value=" -100 " onclick="setPower(-100);" />
    <input class="menu" type="button" value=" -10 " onclick="setPower(-10);" />
    <input class="menu" type="button" value="  ВЫКЛ  " onclick="sendPower(0);" />
    <input class="menu" type="button" value=" +10 " onclick="setPower(10);" />
    <input class="menu" type="button" value=" +100 " onclick="setPower(100);" />
    </div>
</td></tr>
</tbody>
</table>

<table style="margin-top: 10px;">
<tbody class="temp_sensors" style="background-color: lightgray;"></tbody>
<tbody>
    <tr class="extColdInfo" style="display: none;"><td>Охлаждение: </td><td class="WaterOn bold"></td></tr>
    <tr class="extColdInfo" style="display: none;"><td>T охлаждения вход: </td><td class="TempWaterIn bold"></td></tr>
    <tr class="extColdInfo" style="display: none;"><td>T охлаждения выход: </td><td class="TempWaterOut bold"></td></tr>
    <tr class="extColdInfo" style="display: none;"><td>Поток воды: </td><td class="WaterFlow bold"></td></tr>
</tbody>

<tr>
<td>
    <a>Клапан воды:</a>
    <p class="klp_pwm_0 bold"></p>
</td><td>
    <a class="klp_status_0 bold"></a>
    <input type="button" onclick="klp_on(0);" style="margin-left: 10px; color: green;" value="On" />
    <input type="button" onclick="klp_off(0);" style="margin-left: 10px; color:red;" value="Off" />
    <input class="klp_inp klp_shim_0" type="text" id="k_shim_0" maxlength="5" size="3" value="0" /> сек.
    <input class="klp_inp klp_on_0" type="text" id="k_on_0" maxlength="5" size="3" value="0" />%
    <input style="margin-left: 10px;" type="button" onclick="klp_shim_on(0, 'k_shim_0', 'k_on_0');" value="Шим" />
</td></tr>

<tr><td>
    <a>Клапан голов/хвостов:</a>
    <p class="klp_pwm_1 bold"></p>
</td><td>
    <a class="klp_status_1 bold"></a>
    <input type="button" onclick="klp_on(1);" style="margin-left: 10px; color: green;" value="On" />
    <input type="button" onclick="klp_off(1);" style="margin-left: 10px; color:red;" value="Off" />
    <input class="klp_inp klp_shim_1" type="text" id="k_shim_1" maxlength="5" size="3" value="0" /> сек.
    <input class="klp_inp klp_on_1" type="text" id="k_on_1" maxlength="5" size="3" value="0" />%
    <input style="margin-left: 10px;" type="button" onclick="klp_shim_on(1, 'k_shim_1', 'k_on_1');" value="Шим" />
</td></tr>

<tr><td>
    <a>Клапан продукта:</a>
    <p class="klp_pwm_2 bold"></p>
</td><td>
    <a class="klp_status_2 bold"></a>
    <input type="button" onclick="klp_on(2);" style="margin-left: 10px; color: green;" value="On" />
    <input type="button" onclick="klp_off(2);" style="margin-left: 10px; color:red;" value="Off" />
    <input class="klp_inp klp_shim_2" type="text" id="k_shim_2" maxlength="5" size="3" value="0" /> сек.
    <input class="klp_inp klp_on_2" type="text" id="k_on_2" maxlength="5" size="3" value="0" />%
    <input style="margin-left: 10px;" type="button" onclick="klp_shim_on(2, 'k_shim_2', 'k_on_2');" value="Шим" />
</td></tr>

<tr><td>
    <a>Клапан 4:</a>
    <p class="klp_pwm_3 bold"></p>
</td><td>
    <a class="klp_status_3 bold"></a>
    <input type="button" onclick="klp_on(3);" style="margin-left: 10px; color: green;" value="On" />
    <input type="button" onclick="klp_off(3);" style="margin-left: 10px; color:red;" value="Off" />
    <input class="klp_inp klp_shim_3" type="text" id="k_shim_3" maxlength="5" size="3" value="0" /> сек.
    <input class="klp_inp klp_on_3" type="text" id="k_on_3" maxlength="5" size="3" value="0" />%
    <input style="margin-left: 10px;" type="button" onclick="klp_shim_on(3, 'k_shim_3', 'k_on_3');" value="Шим" />
</td></tr>
<table>

<tbody>
<tr class="rect_time_stab_i">
    <td>Время стабилизации: </td><td class="bold rect_time_stab"></td>
</tr>
<tr class="rect_timer1_i"><td>Таймер ре-стабилизации: </td><td class="bold rect_timer1"></td></tr>
<tr class="rect_t_stab_i">
    <td>Температура стабилизации: </td>
    <td class="bold rect_t_stab"></td>
    <td>
        <input class="tstab_inp" type="text" id="tstab" maxlength="5" size="3" value=""/>
        <input type="button" onclick="setTstab();" value="SET" style="margin-left: 10px;" />
    </td>
</tr>
<tr class="rect_p_shim_i">
    <td>ШИМ отбора: </td>
    <td class="bold rect_p_shim"></td>
    <!--
    <td>
        <input class="pwmSr_inp" type="text" id="pwmSr" maxlength="3" size="3" value=""/>
        <input type="button" onclick="setPWMsr();" value="SET" style="margin-left: 10px;" />
    </td>-->
</tr>
</tbody></table>
    <div>
        <input type="button" class="i_start bold" value="ПУСК" style="display: none; background: rgba(87, 181, 115, 0.26); width: 120px;" onclick="StartProcess();" />
        <input type="button" class="i_end bold" value="СТОП" style="background:rgb(225, 201, 201); display: none; width: 120px;" onclick="EndProcess();" />
    <div>
</div>
<!-- main div-->

<div class="modes testklp" style="text-align: left; width: 100%; overflow: auto; margin-bottom: 10px; display: none;">
<table class="param" style="margin-left:0;"><thead>
<tr><th>Клапан</th><th>Назначение</th><th>Состояние</th><th>Период шим</th><th>процент вкл.</th><th colspan="2"></th></tr>
</thead><tbody>
<tr><td>#1 </td><td class="ta_l bold">Клапан воды</td><td class="klp_status_0"></td>
<td class="ta_l"><input type="text" class="klp_shim_0" id="klp_shim_0" maxlength="5" size="3" value="10"/> сек.</td>
<td class="ta_l"><input type="text" class="klp_on_0" id="klp_on_0" maxlength="5" size="3" value="50"/> %</td>
<td><input type="button" onclick="klp_on(0);" style="color: green;" value="Включить" />
<input type="button" onclick="klp_off(0);" style="color:red;" value="Выключить" /></td>
<td><input type="button" onclick="klp_shim_on(0,'klp_shim_0','klp_on_0');" value="Активировать Шим" /></td></tr>
<tr><td>#2 </td><td class="ta_l bold">Клапан голов/хвостов</td><td class="klp_status_1"></td>
<td class="ta_l"><input type="text" class="klp_shim_1" id="klp_shim_1" maxlength="5" size="3" value="10"/> сек.</td>
<td class="ta_l"><input type="text" class="klp_on_1" id="klp_on_1" maxlength="5" size="3" value="50"/> %</td>
<td><input type="button" onclick="klp_on(1);" style="color: green;" value="Включить" />
<input type="button" onclick="klp_off(1);" style="color:red;" value="Выключить" /></td>
<td><input type="button" onclick="klp_shim_on(1,'klp_shim_1','klp_on_1');" value="Активировать Шим" /></td></tr>
<tr><td>#3 </td><td class="ta_l bold">Клапан продукта</td><td class="klp_status_2"></td>
<td class="ta_l"><input type="text" class="klp_shim_2" id="klp_shim_2" maxlength="5" size="3" value="10"/> сек.</td>
<td class="ta_l"><input type="text" class="klp_on_2" id="klp_on_2" maxlength="5" size="3" value="50"/> %</td>
<td><input type="button" onclick="klp_on(2);" style="color: green;" value="Включить" />
<input type="button" onclick="klp_off(2);" style="color:red;" value="Выключить" /></td>
<td><input type="button" onclick="klp_shim_on(2,'klp_shim_2','klp_on_2');" value="Активировать Шим" /></td></tr>
<tr><td>#4 </td><td class="ta_l bold">Дополнительный</td><td class="klp_status_3"></td>
<td class="ta_l"><input type="text" class="klp_shim_3" id="klp_shim_3" maxlength="5" size="3" value="10"/> сек.</td>
<td class="ta_l"><input type="text" class="klp_on_3" id="klp_on_3" maxlength="5" size="3" value="50"/> %</td>
<td><input type="button" onclick="klp_on(3);" style="color: green;" value="Включить" />
<input type="button" onclick="klp_off(3);" style="color:red;" value="Выключить" /></td>
<td><input type="button" onclick="klp_shim_on(3,'klp_shim_3','klp_on_3');" value="Активировать Шим" /></td></tr>
</tbody></table>
</div>


</div>
</div>

<div class="pages" id="net_setup" style="display: none;">
<h2>Настройки сети</h2>
<table class="param"><tbody>
<tr><td class="ta_r">Имя хоста:</td>
<td class="ta_l"> <input id="host" type="text" size="20" maxlength="20"></td></tr>
<tr><td class="ta_r">Всегда требовать пароль:</td>
<td class="ta_l"> <input type="checkbox" id="secure" value="1"></td></tr>
<tr><td class="ta_r">Новое имя пользователя:</td>
<td class="ta_l"><input id="newusername" type="text" size="20" maxlength="20"></td></tr>
<tr><td class="ta_r">Новый пароль:</td>
<td class="ta_l"><input id="newpasswd" type="password" size="20" maxlength="16"></td></tr>
<tr><td class="ta_r">Повтор нового пароля:</td>
<td class="ta_l"><input id="newpasswd2" type="password" size="20" maxlength="16"></td></tr>
<tr><td class="ta_c" style="display: none; color: red;" colspan="2" id="passmatch">Пароли не совпадают!!</td></tr>

<tr><td class="ta_r">Использовать сервис smsc.ru:</td>
<td class="ta_l"> <input type="checkbox" id="useSmsc" value="1"></td></tr>
<tr><td class="ta_r">Имя пользователя smsc:</td>
<td class="ta_l"> <input id="smscUser" type="text" size="20" maxlength="20"></td></tr>
<tr><td class="ta_r">Хэш пароля для smsc:</td>
<td class="ta_l"> <input id="smscHash" type="text" size="80" maxlength="80"></td></tr>
<tr><td class="ta_r">Телефоны для отправки sms:</td>
<td class="ta_l"> <input id="smscPhones" type="text" size="80" maxlength="80"></td></tr>

<tr><td class="ta_r">Использовать бот Telegram:</td>
<td class="ta_l"> <input type="checkbox" id="useTlg" value="1"></td></tr>
<tr><td class="ta_r">Токен бота:</td>
<td class="ta_l"> <input id="tokenTlg" type="text" size="60" maxlength="60"> <input type="button" id="tlg_test" onclick="telegramTest();" value="Тест" /> </td></tr>
<tr><td class="ta_r">ID чата:</td>
<td class="ta_l"> <input id="chatidTlg" type="text" size="30" maxlength="30"></td></tr>

<tr><td class="ta_r" style="border-top: 2px solid;">Период обновления для websocket:</td>
<td class="ta_l" style="border-top: 2px solid;"> <input id="wsPeriod" type="text" size="3" maxlength="4"> Сек.</td></tr>
<tr><td class="ta_r">Time zone (GMT 0-12):</td>
<td class="ta_l"> <input id="timezone" type="text" size="2" maxlength="3"></td></tr>
<tr><td class="ta_r">zero detector shift:</td>
<td class="ta_l"> <input id="z_shift" type="number" size="3" maxlength="3"></td></tr>

<tr><td class="ta_c" colspan="2"><input type="button" id="net_save_cfg" onclick="save_network();" value="Сохранить настройки" /></td></tr>
<tr><td colspan="2" id="net_saveok" class="ta_c" style="font-weight: bold; color:green; display: none;">New setting will be effective after restart.</td></tr>
<tr><td class="ta_c" colspan="2" class="ta_c" style="color: red; display: none;" id="net_save_fail">Update failed!!</td></tr>
</tbody></table>
</div>

<div class="pages" id="param_setup" style="display: none;">
    <table class="param"><tbody>
        <tr><td colspan="2" class="ta_l" style="background-color: var(--frame-brd-color);"><h3>Общие настройки</h3></td></tr>

        <tr><td colspan="2" class="ta_subtitle">Регулятор-стабилизатор</td></tr>
        <tr><td class="ta_r">Не используется: </td> <td class="ta_l"><input id="no_power" type="checkbox" value=1></td></tr>
        <tr><td class="ta_r">Номинальная мощность ТЭНов: </td><td class="ta_l"><input id="maxPower" type="text" size="5" maxlength="8"> Вт.</td></tr>
        <tr><td class="ta_r">PZEM протокол v.30 (modbus RTU) <span class="red">*</span>: </td><td class="ta_l"><input id="pzemVersion" type="checkbox" value=1>Да</td></tr>
        <tr><td colspan="2" class="ta_subtitle">Звук</td></tr>
        <tr><td class="ta_r">Тихий режим работы клапанов: </td> <td class="ta_l"><input id="klpSilentNode" type="checkbox" value=1></td></tr>
        <tr><td class="ta_r">Звук при переключении режимов: </td> <td class="ta_l"><input id="beepChangeState" type="checkbox" value=1></td></tr>
        <tr><td colspan="2" class="ta_subtitle">Сервис</td></tr>
        <tr><td class="ta_r">Gpio включенный во время процесса (0 - нет): </td><td class="ta_l"><input id="processGpio" type="text" size="8" maxlength="8" value="0"></td></tr>
        <tr><td class="ta_r">Выход на клапан воды питает насос: </td> <td class="ta_l"><input id="klp1_isPWM" type="checkbox" value=1></td></tr>
        <!--<tr><td class="ta_r">Поправка для датчика давления: </td><td class="ta_l"><input id="p_MPX5010" type="text" size="4" maxlength="4"></td></tr>-->
        
        <tr><td colspan="2" class="ta_subtitle">Опции безопасности</td></tr>
        <!--<tr><td class="ta_r">Давление срабатывания тревоги: </td><td class="ta_l"><input id="alarmMPX5010" type="text" size="8" maxlength="8"></td></tr>-->
        <tr><td class="ta_r">Выключать дифф-автомат по тревоге Т: </td>
            <td class="ta_l"><input id="alarmDIFFoffT" type="checkbox" value=0></td></tr>
        <tr><td class="ta_r">Выключать дифф-автомат по превышению мощности: </td>
            <td class="ta_l"><input id="alarmDIFFoffP" type="checkbox" value=0></td></tr>
        <tr><td class="ta_r">Задержка выключения дифф-автомата, сек: </td>
            <td class="ta_l"><input id="DIFFoffDelay" type="text" size="4" maxlength="4"></td></tr>
        <tr><td class="ta_r">Выключать дифф-автомат при старте: </td>
            <td class="ta_l"><input id="DIFFoffOnStart" type="checkbox" value=0></td></tr>
        <tr><td class="ta_r">Выключать дифф-автомат при завершении: </td>
            <td class="ta_l"><input id="DIFFoffOnStop" type="checkbox" value=0></td></tr>

        <tr><td colspan="2" class="ta_l" style="background-color: var(--frame-brd-color);"><h3>Ректификация</h3></td></tr>
        <tr><td class="ta_r">Мощность ректификации: </td>
            <td class="ta_l"><input id="powerRect" type="text" size="5" maxlength="8"> Вт.</td></tr>

        <tr><td colspan="2" class="ta_subtitle">Разгон</td></tr>
        <!--<tr><td class="ta_r">Мощность разгона: </td><td class="ta_l"><input id="powerRazgon" type="text" size="5" maxlength="8"> Вт.</td></tr>-->
        <tr><td class="ta_r">Разгон до Т куба: </td>
            <td class="ta_l"><input id="tempEndRectRazgon" type="text" size="4" maxlength="4"> C</td></tr>

        <tr><td colspan="2" class="ta_subtitle">Головы</td></tr>
        <tr><td class="ta_r">Период для шим'a отбора голов: </td>
            <td class="ta_l"><input id="timeChimRectOtbGlv" type="text" size="4" maxlength="4"> Сек</td></tr>
        <tr><td class="ta_r">Процент ШИМ отбора голов: </td>
            <td class="ta_l"><input id="procChimOtbGlv" type="text" size="3" maxlength="3"> %</td></tr>
        <tr><td class="ta_r">Отбор голов до (+Т куба,- Время в минутах): </td>
            <td class="ta_l"><input id="tEndRectOtbGlv" type="text" size="6" maxlength="6"> C</td></tr>
        <!--<tr><td class="ta_r">Уровень проводимости, меньше которого переходим к СР: </td>
            <td class="ta_l"><input id="urovenProvodimostSR" type="text" size="6" maxlength="6" /></td></tr>-->

        <tr><td colspan="2" class="ta_subtitle">Тело</td></tr>
        <tr><td class="ta_r">Время стабилизации колонны(+отн.,-абс.): </td>
            <td class="ta_l"><input id="timeStabKolonna" type="text" size="6" maxlength="6" /> Сек.</td></tr>
        <tr><td class="ta_r">Период ШИМ отбора СР: </td>
            <td class="ta_l"><input id="timeChimRectOtbSR" type="text" size="4" maxlength="4"> Сек.</td></tr>
        <tr><td class="ta_r">Начальный % ШИМ отбора СР: </td>
            <td class="ta_l"><input id="beginProcChimOtbSR" type="text" size="3" maxlength="3"> %</td></tr>
        <tr><td class="ta_r">Минимальный процент ШИМ'а отбора СР: </td>
            <td class="ta_l"><input id="minProcChimOtbSR" type="text" size="3" maxlength="3"> %</td></tr>
        <tr><td class="ta_r">Количество значений в таблице обучения ШИМ: </td>
            <td class="ta_l"><input id="cntCHIM" type="text" size="8" maxlength="8" /></td></tr>
        <tr><td class="ta_r">Допуск температуры до стопа/рестабилизации: </td>
            <td class="ta_l"><input id="tempDeltaRect" type="text" size="4" maxlength="4"> C</td></tr>
        <tr><td class="ta_r">Уменьшение % ШИМ отбора при 'стоп'(+абс,-относ.): </td>
            <td class="ta_l"><input id="decrementCHIM" type="text" size="3" maxlength="3" /> %</td></tr>
        <tr><td class="ta_r">Таймаут рестабилизации(переход к отбору): </td>
            <td class="ta_l"><input id="timeRestabKolonna" type="text" size="8" maxlength="8"> Сек.</td></tr>
        <tr><td class="ta_r">Время без 'стоп' до увеличения ШИМ: </td>
            <td class="ta_l"><input id="timeAutoIncCHIM" type="text" size="5" maxlength="5"> Сек</td></tr>
        <tr><td class="ta_r">Шаг увеличения % ШИМ (+абс.,-относит.): </td>
            <td class="ta_l"><input id="incrementCHIM" type="text" size="3" maxlength="3" /> %</td></tr>
        <tr><td class="ta_r">Температура(+куб,-низ колонны) завершения тела: </td>
            <td class="ta_l"><input id="tempEndRectOtbSR" type="text" size="5" maxlength="5"/> C</td></tr>

        <tr><td colspan="2" class="ta_subtitle">Хвост</td></tr>
        <tr><td class="ta_r">Температура [куба] завершения ректификации: </td>
            <td class="ta_l"><input id="tempEndRect" type="text" size="4" maxlength="4" /> C</td></tr>
            
        <tr><td colspan="2" class="ta_l" style="background-color: var(--frame-brd-color);"><h3>Дистилляция</h3></td></tr>
        <tr><td class="ta_r">Мощность в режиме дистилляции: </td>
            <td class="ta_l"><input id="powerDistil" type="text" size="5" maxlength="8"> Вт.</td></tr>
        <tr><td class="ta_r">Разгон до Т куба: </td>
            <td class="ta_l"><input id="tEndDistRazgon" type="text" size="4" maxlength="4" /> C</td></tr>
        <tr><td class="ta_r">Т [куба] завершения дистилляции: </td>
            <td class="ta_l"><input id="tEndDistil" type="text" size="4" maxlength="4"  /> C</td></tr>

        <tr><td colspan="2" class="ta_l" style="background-color: var(--frame-brd-color);"><h3>Регулятор мощности</h3></td></tr>
        <tr><td class="ta_r">Мощность в режиме регулятора мощности: </td>
            <td class="ta_l"><input id="ustPowerReg" type="text" size="5" maxlength="8"> Вт.</td></tr>
        <tr><td class="ta_r" colspan="2">&nbsp;</td></tr>

        <tr><td colspan="2" class="ta_c">
        <input type="button" value="Восстановить по умолчанию" onclick="default_parameters();"/>
        <input type="button" value="Сохранить изменения" onclick="set_parameters();"/>
</td></tr>

</tbody></table>
</div>

<div class="pages" id="sens_setup" style="display: none;">
<div style="display:flex; align-items: center;">
    <h2>Температурные датчики</h2>
    <input type="checkbox" id="emuswitch" onclick="emu();" value="Эмуляция"> 
    <a>Эмуляция</a>
</div>    
<div>
    <a href="#" onclick="rescan_sens(); return false;">[Сканировать шину]</a>
    <a class="emuframe" style="display:none;">
        Эмулировать:
        <select id="emuType">
            <option value="0">Температура в кубе</option>
            <option value="1">Температура нижней части колонны</option>
            <option value="2">Температура верней части колонны</option>
            <option value="3">Температура в дефлегматоре</option>
            <option value="4">Температура воды охлаждения, вход</option>
            <option value="5">Температура воды охлаждения, выход</option>
            <option value="6">Аварийный датчик температуры</option>
            <option value="7">Не назначено</option>
        </select>
        Т,C:
        <input type="text" id="emuTinp" maxlength="5"/>
        <input type="button" value=" SET " onclick="emuT();"/>
    </a>
</div>
<table class="param" id="sens_table" style="width: 80%;">
<thead>
<tr><th>ID</th>
<th>Rom</th>
<th>Температура</th>
<th>Тип</th>
<th>Коррекция</th>
<th>Описание</th>
<th>Alarm</th>
</tr>
</thead><tbody id="sens_list">
</tbody></table>

<div id="sens_form" style="display: none;">
<table class="param"><tbody>
<tr><td class="ta_r">ROM адрес: </td>
<td class="ta_l" id="rom"></td></tr>
<tr><td class="ta_r">Назначение: </td>
<td class="ta_l"><select id="type">
<option value="0">Температура в кубе</option>
<option value="1">Температура нижней части колонны</option>
<option value="2">Температура верней части колонны</option>
<option value="3">Температура в дефлегматоре</option>
<option value="4">Температура воды охлаждения, вход</option>
<option value="5">Температура воды охлаждения, выход</option>
<option value="6">Аварийный датчик температуры</option>
<option value="7">Не назначено</option>
</select></td></tr>
<tr><td class="ta_r">Описание: </td>
<td class="ta_l"><input id="descr" type="text" size="40" maxlength="80" /></td></tr>
<tr><td class="ta_r">Коррекция температуры: </td>
<td class="ta_l"><input id="corr" type="text" size="4" maxlength="4" /> C</td></tr>
<tr><td class="ta_r">Температура тревоги: </td>
<td class="ta_l"><input id="talert" type="text" size="4" maxlength="4" /> C</td></tr>
<tr><td colspan="2" class="ta_c">
<input type="button" value="Вернутся" onclick="cancel_sens();"/>
<input type="button" value="Сохранить" onclick="update_sens();"/>
</td></tr>
</tbody></table>
</div>
</div>

<div class="pages" id="wifi_setup" style="display: none;">
<h2>Найденые Wifi сети <a href="#wifi_setup" onclick="disp_wifi(); return false;">Обновить</a>
<input type="button" onclick="do_reset();" value="Перезагрузка"/>
</h2>
<table class="param" style="width: 80%;">
<thead>
<tr><th>SSID</th>
<th>Signal lvl.</th>
<th>CH #</th>
<th>Auth mode</th></tr>
</thead><tbody id="wifi_ap_list">
</tbody></table>

<h2>Известные Wifi сети </h2>
<table class="param" style="width: 80%;">
<thead>
<tr><th>SSID</th>
<th>Password</th>
<th>&nbsp;</th>
</thead><tbody id="wifi_know_ap">
</tbody></table>

<div id="wifi_form" style="padding-top: 15px; overflow: auto;">
<form id="form1" onsubmit="return false;">
<table class="param"><tbody>
<tr><th class="ta_r va_m">SSID:&nbsp;</th>
<td><input name="ap_ssid" type="text" id="ap_ssid" maxlength="32"/></td></tr>
<tr><th class="ta_r va_m">Пароль:&nbsp;</th>
<td><input name="ap_pass" type="text" id="ap_pass" maxlength="32"/></td></tr>
<tr><td colspan="2" class="ta_c">
<input type="button" value="Добавить" onclick="add_wifi_ap();"/>
<input type="button" value="Отмена" onclick="cancel_wifi();"/>
</td></tr>
<tr><td colspan="2" id="wifi_saveok" class="ta_c bold" style="color:green; display: none;">Добавлено.</td></tr>
<tr><td class="ta_c" colspan="2" class="ta_c" style="color: red; display: none;" id="add_wifi_fail">Ошибка добавления!!</td></tr>
</tbody></table>

</form></div>

</div>

<div class="pages" id="dir_list" style="display: none;">
<h2>Список файлов</h2>
<table class="param">
<thead>
<tr><th>Имя</th>
<th>Размер</th>
<th>&nbsp;</th></tr>
</thead><tbody id="dir_file_list">
</tbody></table>
</div>


</div><!--left panel-->

<div class="fpanel" style = "width:300px;">
<span class="log"></span>
</div> <!--left panel-->

</div> <!--multiwin-->
<div class="footer">
<span class="ta_l" style="padding-left: 15px;">hd_esp32 Copyright &copy; 2020,
</span>
<span class="Version"></span>
<span class="usedBytes"></span>
<span class="totalBytes"></span>
<span class="heap"></span>
<span class="rReason"></span>
</div>

</div>
<script>
$( "input" ).focus(function() {
  $( this ).data("focused", 1);
});

$( "input" ).blur(function() {
  $( this ).data("focused", 0);
});

switch_mode = function(new_mode) {
  $("#sw_mode").prop("disabled", true);
  $.post('/setmainmode', {
        'new_mode': $('#new_mode').val(),
  }, function(d) {
	showStick(d.err, d.msg);
	disp_main();
  }, 'json');
}

prev_status = function() {
  //$("#prev_status").hide();
  $("#prev_status").prop("disabled", true);
  $.post('/set_status', {
        'new': 0,
  }, function(d) {
	showStick(d.err, d.msg);
	disp_main();
  }, 'json');
}

next_status = function() {
  //$("#next_status").hide();
  $("#next_status").prop("disabled", true);
  $.post('/set_status', {
        'new': 1,
  }, function(d) {
	showStick(d.err, d.msg);
	disp_main();
  }, 'json');
}

StartProcess = function() {
 $.get('/startprocess', {
 }, function(d) {
	showStick(d.err, d.msg);
  }, 'json');
}
EndProcess = function() {
 $.get('/endprocess', {
 }, function(d) {
	showStick(d.err, d.msg);
  }, 'json');
}

sendPower = function(newPower) {
 $.post('/setpower', {
        'power': newPower,
 }, function(d) {
	showStick(d.err, d.msg);
	disp_main();
 }, 'json');
}

setPower = function(delta) {
 let newPower = $(".SetPower").data("power");
 if (delta==0) 
    newPower = eval($('#new_power').val());
 else
    newPower += delta;
 if (newPower<0) newPower=0;
 sendPower(newPower);
}

klp_disp = function(id) {
  $.get('/klp_status', {
        'id': id
  }, function (d){ display_one_valve(d);}
  , 'json');
}

display_one_valve = function(k) {
        var open_html;
        var pwm_html;
        if (eval(k.is_open)) open_html = "Открыт";
        else open_html = "Закрыт";
        
        if (eval(k.is_pwm)){
          pwm_html = "ШИМ "+k.pwm_time+"сек "+k.pwm_percent+" %";
          
        } else {
          pwm_html = "";
        }
        
        $(".klp_status_"+k.id).html(open_html);
        $(".klp_pwm_"+k.id).html(pwm_html);
        
        if (($(".klp_shim_"+k.id).data("focused")==0)&& ($(".klp_on_"+k.id).data("focused")==0)) {
          $(".klp_on_"+k.id).val(k.pwm_percent);
          $(".klp_shim_"+k.id).val(k.pwm_time);
        }
}

display_valves = function(valves_array) {
    if (typeof(valves_array)=="undefined") return;
    
	for (var i in valves_array) {
        display_one_valve(valves_array[i]);
    }
}

klp_on = function(id) {
 $.post('/klp_on', {
        'id': id
 }, function(d) {
	klp_disp(id);
 }, 'json');
}

klp_off = function(id) {
 $.post('/klp_off', {
        'id': id
 }, function(d) {
	klp_disp(id);
 }, 'json');
}

klp_shim_on = function(id, n1, n2) {
 $.post('/klp_shim_on', {
        'id': id,
        'period': $('#'+n1).val(),
        'klp_on': $('#'+n2).val()
 }, function(d) {
	klp_disp(id);
 }, 'json');
}

setTstab = function() {
 $.post('/tstab', {'t': $('#tstab').val()},
  function(d) {
	showStick(d.err, d.msg);
    if (eval(d.err)==0) $(".rect_t_stab").html($('#tstab').val()+" C");
  }, 'json');
}

setPWMsr = function() {
 $.post('/pwmsr', {'p': $('#pwmSr').val()},
  function(d) {
	showStick(d.err, d.msg);
    if (eval(d.err)==0) $(".rect_p_shim").html($('#pwmSr').val()+"%");
  }, 'json');
}

prev_mode  = -1;
prev_state = -1;

putModeStat = function(d){
    //if ($(".MainMode").data("focused")==0) {
    let main_mode   = eval(d.MainMode);
    let main_status = eval(d.MainStatus);
    
    if ((prev_mode==main_mode)&&(prev_state==main_status)) return;
    prev_mode = main_mode;
    prev_state= main_status
    
    let disable_mode_change = (((main_mode == 2)||(main_mode == 3)) && ((main_status>0)&&(main_status<100)));
    
    $(".MainMode").val(main_mode);
       
	$(".MainModeStr").html(d.MainModeStr);
	$(".MainStatusStr").html(d.MainStatusStr);
	$(".ModeStr").html(d.MainModeStr);
	$(".stateStr").html(d.MainStatusStr);
    
    if ((main_mode == 2)||(main_mode == 3)){ //rect or distill
		$('#prev_status').show();
		$('#next_status').show();
		$('.i_start').show();
		$('.i_end').show();
        
        $('.i_end').prop("disabled",   ((main_status==0)||(main_status==100))  );
        $('.i_start').prop("disabled", (!((main_status==0)||(main_status==100))) );
        $('#prev_status').prop("disabled", (main_status==0)  );
        $('#next_status').prop("disabled", (main_status==100) );
    }
    else {
		$('#prev_status').hide();
		$('#next_status').hide();
		$('.i_start').hide();
		$('.i_end').hide();
        disable_mode_change = false;
    }
    
    $(".MainMode").prop("disabled", disable_mode_change);
    $("#sw_mode").prop("disabled",  disable_mode_change);
}

disp_main = function() {
  $(".pages").hide();
  $(".modes").hide();

  $.get('/maininfo', {}, function(d) {
    create_sensor_table(d);
    infoUpdate(d);
	//$("#sw_mode").show();
	//$("#prev_status").show();
	//$("#next_status").show();
	if (extColdConnected) $(".extColdInfo").show();
    
	switch(eval(d.MainMode)) {
	case 2:
		$('.distill').show();
		break;
	case 10:
		$('.testklp').show();
		break;
	}
  }, 'json');

  $("#main_div").show();
  window.location.hash = '#';
}

save_network = function () {
  var secure=0, useSmsc=0;
  if($('#secure').is(':checked')) secure=1;
  if($('#useSmsc').is(':checked')) useSmsc=1;
  if($('#useTlg').is(':checked')) useTlg=1;
  $.post('/netcfg', {
	'host': $('#host').val(),
	'user': $('#newusername').val(),
	'pass': $('#newpasswd').val(),
	'secure': secure,
	'smscUser': $('#smscUser').val(),
	'smscHash': $('#smscHash').val(),
	'smscPhones': $('#smscPhones').val(),
	'useSmsc':useSmsc,
    
	'tokenTlg': $('#tokenTlg').val(),
	'chatidTlg': $('#chatidTlg').val(),
	'useTlg':useTlg,
    
	'wsPeriod': $('#wsPeriod').val(),
	'timezone': $('#timezone').val(),
	'z_shift': $('#z_shift').val()
   }, function(d) {
	$('#net_saveok').show();
   }, 'json')
   .fail(function() {
	$('#net_save_fail').show();
   })
   .always(function() {
   });
}

disp_network = function () {
  $(".pages").hide();
  $.get('/netcfg', {}, function(d) {
	$("#host").val(d.host);
	$("#newusername").val(d.user);
	if (eval(d.secure)) $('#secure').prop('checked', 1);
	else $('#secure').removeAttr('checked');
	$('#smscUser').val(d.smscUser);
	$('#smscHash').val(d.smscHash);
	$('#smscPhones').val(d.smscPhones);
	if (eval(d.useSmsc)) $('#useSmsc').prop('checked', 1);
	else $('#useSmsc').removeAttr('checked');

	$('#tokenTlg').val(d.tokenTlg);
	$('#chatidTlg').val(d.chatidTlg);
	if (eval(d.useTlg)) $('#useTlg').prop('checked', 1);
	else $('#useTlg').removeAttr('checked');
    
	$('#wsPeriod').val(d.wsPeriod);
	$('#timezone').val(d.timezone);
	$('#z_shift').val(d.z_shift);

	$("#passmatch").hide();
	$("#saveok").hide();
	$("#net_save_fail").hide();
  }, 'json');
	window.location.hash = '#net_setup';
	$("#net_setup").show();
}


default_parameters = function() {
  $.get('/defparam', {}, function(d) {
       disp_setting();
   }, 'json');
}

set_parameters = function() {
  var beepChangeState=0, klpSilentNode=0, klp1_isPWM=0, pzemVersion=0, no_power=0;
  var alarmDIFFoffT=0,alarmDIFFoffP=0,DIFFoffOnStart=0,DIFFoffOnStop=0;

  if($('#beepChangeState').is(':checked')) beepChangeState=1;
  if($('#klpSilentNode').is(':checked')) klpSilentNode=1;
  if($('#klp1_isPWM').is(':checked')) klp1_isPWM=1;
  if($('#pzemVersion').is(':checked')) pzemVersion=1;
  if($('#no_power').is(':checked')) no_power=1;

  if($('#alarmDIFFoffT').is(':checked')) alarmDIFFoffT=1;
  if($('#alarmDIFFoffP').is(':checked')) alarmDIFFoffP=1;
  if($('#DIFFoffOnStart').is(':checked')) DIFFoffOnStart=1;
  if($('#DIFFoffOnStop').is(':checked')) DIFFoffOnStop=1;

  $.post('/saveparam', {
        'maxPower': $("#maxPower").val(),
        'ustPowerReg': $("#ustPowerReg").val(),
	'tempEndRectRazgon': $("#tempEndRectRazgon").val(),
	'powerRect': $("#powerRect").val(),
	'tEndRectOtbGlv': $("#tEndRectOtbGlv").val(),
	'timeChimRectOtbGlv': $("#timeChimRectOtbGlv").val(),
	'procChimOtbGlv': $("#procChimOtbGlv").val(),
	'minProcChimOtbSR': $("#minProcChimOtbSR").val(),
	'tempStabSR': $("#tempStabSR").val(),
	'beginProcChimOtbSR': $("#beginProcChimOtbSR").val(),
	'timeChimRectOtbSR': $("#timeChimRectOtbSR").val(),
	'tempDeltaRect': $("#tempDeltaRect").val(),
	'tempEndRectOtbSR': $("#tempEndRectOtbSR").val(),
	'tempEndRect': $("#tempEndRect").val(),
	'p_MPX5010': $("#p_MPX5010").val(),
	'timeStabKolonna': $("#timeStabKolonna").val(),
	'timeRestabKolonna': $("#timeRestabKolonna").val(),
	'klpSilentNode': klpSilentNode,
	'urovenProvodimostSR': $("#urovenProvodimostSR").val(),
	'cntCHIM': $("#cntCHIM").val(),
	'decrementCHIM': $("#decrementCHIM").val(),
	'incrementCHIM': $("#incrementCHIM").val(),
	'timeAutoIncCHIM': $("#timeAutoIncCHIM").val(),
        'powerDistil': $("#powerDistil").val(),
        'tEndDistRazgon': $("#tEndDistRazgon").val(),
        'tEndDistil': $("#tEndDistil").val(),
	'alarmMPX5010': $("#alarmMPX5010").val(),
	'beepChangeState': beepChangeState,
	'klp1_isPWM': klp1_isPWM,
	'pzemVersion': pzemVersion,
    'no_power':no_power,
	'processGpio': $("#processGpio").val(),
    'alarmDIFFoffT': alarmDIFFoffT,
    'alarmDIFFoffP': alarmDIFFoffP,
    'DIFFoffOnStart': DIFFoffOnStart,
    'DIFFoffOnStop': DIFFoffOnStop,
    'DIFFoffDelay': $("#DIFFoffDelay").val()
   }, function(d) {
       disp_setting();
   }, 'json');

}

disp_setting = function() {
  $(".pages").hide();
  $.get('/rectparam.json', {}, function(d) {
        $("#maxPower").val(d.maxPower);
        $("#ustPowerReg").val(d.ustPowerReg);
	$("#tempEndRectRazgon").val(d.tempEndRectRazgon);
	$("#powerRect").val(d.powerRect);
	$("#tEndRectOtbGlv").val(d.tEndRectOtbGlv);
	$("#timeChimRectOtbGlv").val(d.timeChimRectOtbGlv);
	$("#procChimOtbGlv").val(d.procChimOtbGlv);
	$("#minProcChimOtbSR").val(d.minProcChimOtbSR);
	$("#tempStabSR").val(d.tempStabSR);
	$("#beginProcChimOtbSR").val(d.beginProcChimOtbSR);
	$("#timeChimRectOtbSR").val(d.timeChimRectOtbSR);
	$("#tempDeltaRect").val(d.tempDeltaRect);
	$("#tempEndRectOtbSR").val(d.tempEndRectOtbSR);
	$("#tempEndRect").val(d.tempEndRect);
	$("#p_MPX5010").val(d.p_MPX5010);
	$("#timeStabKolonna").val(d.timeStabKolonna);
	$("#timeRestabKolonna").val(d.timeRestabKolonna);
	if (eval(d.klpSilentNode)) $('#klpSilentNode').prop('checked', 1);
        else $('#klpSilentNode').removeAttr('checked');
	$("#urovenProvodimostSR").val(d.urovenProvodimostSR);
	$("#cntCHIM").val(d.cntCHIM);
	$("#decrementCHIM").val(d.decrementCHIM);
	$("#incrementCHIM").val(d.incrementCHIM);
	$("#timeAutoIncCHIM").val(d.timeAutoIncCHIM);
        $("#powerDistil").val(d.powerDistil);
        $("#tEndDistil").val(d.tEndDistil);
        $("#tEndDistRazgon").val(d.tEndDistRazgon);
	$("#alarmMPX5010").val(d.alarmMPX5010);
	if (eval(d.beepChangeState)) $('#beepChangeState').prop('checked', 1);
        else $('#beepChangeState').removeAttr('checked');
	if (eval(d.klp1_isPWM)) $('#klp1_isPWM').prop('checked', 1);
	else $('#klp1_isPWM').removeAttr('checked');
    
	if (eval(d.pzemVersion)) $('#pzemVersion').prop('checked', 1);
	else $('#pzemVersion').removeAttr('checked');

	if (eval(d.no_power)) $('#no_power').prop('checked', 1);
	else $('#no_power').removeAttr('checked');

	$("#processGpio").val(d.processGpio);

	if (eval(d.alarmDIFFoffT)) $('#alarmDIFFoffT').prop('checked', 1);
	else $('#alarmDIFFoffT').removeAttr('checked');
	if (eval(d.alarmDIFFoffP)) $('#alarmDIFFoffP').prop('checked', 1);
	else $('#alarmDIFFoffP').removeAttr('checked');
	if (eval(d.DIFFoffOnStart)) $('#DIFFoffOnStart').prop('checked', 1);
	else $('#DIFFoffOnStart').removeAttr('checked');
	if (eval(d.DIFFoffOnStop)) $('#DIFFoffOnStop').prop('checked', 1);
	else $('#DIFFoffOnStop').removeAttr('checked');
    
	$("#DIFFoffDelay").val(d.DIFFoffDelay);

  }, 'json');
  $("#param_setup").show();
  window.location.hash = '#param_setup';
}


cancel_sens = function() {
  Id = -1;
  $("#sens_form").hide();
  $("#sens_table").show();
  $("#rom").html("");
  $("#type").val('0');
  $("#corr").val('0');
  $("#descr").val('');
  $("#talert").val('0');
}

update_sens = function() {
 $.post('/updatesens', {
        'id': Id,
        'type': $('#type').val(),
        'descr': $('#descr').val(),
        'corr': $('#corr').val(),
        'talert': $('#talert').val()
   }, function(d) {
  	$("#rom").html("");
	$("#type").val('0');
	$("#corr").val('0');
	$("#descr").val('');
	$("#talert").val('0');
        $("#sens_form").hide();
	Id = -1;
	showStick(d.err, d.msg);
	disp_sensor();
  }, 'json');
}

edit_sens = function(sens_id) {
  $.get('/senslist', {}, function(d) {
	for (var i in d) {
                var s = d[i];
		if (s.id == sens_id) {
  			Id = sens_id;
			$("#sens_table").hide();
			$("#rom").html(s.rom);
			$("#type").val(s.type);
			$("#descr").val(s.descr);
			$("#corr").val(s.corr);
			$("#talert").val(s.talert);
			$("#sens_form").show();
		}
	}
  }, 'json');
}
rescan_sens = function() {
  $.get('/rescansens', {}, function(d) {
	showStick(d.err, d.msg);
	disp_sensor();
  }, 'json');
}

disp_sensor = function() {
  $(".pages").hide();
  $("#sens_form").hide();
  var t = $('#sens_list');
  t.empty();
  $.get('/senslist', {}, function(d) {
    var html;
	for (var i in d) {
		var s = d[i];
		html = '<tr><td class="ta_c">'+s.id+
		'</td><td><a href="#" onclick="edit_sens('+s.id+'); return false;">'+s.rom+
		'</a></td><td class="sens_'+s.id+'">'+s.temp+' C.</td><td>'+
		s.type_str + '</td><td class="ta_l"> ' +
		s.corr + ' C</td><td class="ta_l"> ' +
		s.descr + '</td><td class="ta_l"> ' +
		s.talert+' C</td></tr>';
		t.append(html);
	}
  }, 'json');
  $("#sens_setup").show();
  $("#sens_table").show();
  window.location.hash = '#sens_setup';
}

emuT =  function(){
 $.post('/emulate', {
        'type': $('#emuType').val(),
        't': $('#emuTinp').val()
   }, function(d) {
	showStick(d.err, d.msg);
	disp_sensor();
  }, 'json');
}

emu = function(){
    if ($("#emuswitch").prop("checked")) {
        $(".emuframe").show();
    }
    else {
        $(".emuframe").hide();
    }
}

wifi_select_ap = function(ssid) {
  $("#ap_ssid").val(ssid);
  $("#ap_pass").val('');
  $("#wifi_form").show();
}
add_wifi_ap = function() {
   $.post('/addwifi', {
        'ssid': $('#ap_ssid').val(),
        'pass': $('#ap_pass').val(),
   }, function(d) {
  	$("#ap_ssid").val('');
	$("#ap_pass").val('');
        $('#wifi_saveok').show();
	disp_wifi();
   }, 'json')
   .fail(function() {
        $('#add_wifi_fail').show();
   })
   .always(function() {
   });
}
remove_wifi_ap = function(ssid) {
   $.post('/delwifi', {
        'ssid': ssid,
   }, function(d) {
	disp_wifi();
   }, 'json')
   .always(function() {
   });

}

cancel_wifi = function() {
  $('#wifi_saveok').hide();
  $('#add_wifi_fail').hide();
  $("#ap_ssid").val('');
  $("#ap_pass").val('');
}

disp_wifi = function() {
  $(".pages").hide();
  var t = $('#wifi_ap_list');
  t.empty();

  $.get('/wifi', {}, function(d) {
	var html;
	for (var i in d) {
		var w = d[i];
		html = '<tr id="'+w.ssid+'"><td class="ta_l"><a href="#" onclick="wifi_select_ap(\''+w.ssid+'\'); return false;">'+w.ssid+
		'</a></td><td>'+w.rssi+' dB.</td><td>'+
		w.primary + '</td><td class="ta_l"> ' +
		w.authmode +'</td></tr>';
		t.append(html);
	}
	$("#wifi_setup").show();
  	$('#wifi_saveok').hide();
	$('#add_wifi_fail').hide();
	window.location.hash = '#wifi_setup';
  }, 'json');

  t = $('#wifi_know_ap');
  t.empty();
  $.get('/wificfg', {}, function(d) {
	var html;
	for (var i in d) {
		var w = d[i];
		html = '<tr id="'+w.ssid+'"><td class="ta_l">'+w.ssid+
		'</td><td>'+w.pass+'</td><td>'+
		'<a href="#" onclick="remove_wifi_ap(\''+w.ssid+'\'); return false;">Remove</a></td></tr>';
		t.append(html);
	}
  }, 'json');
}

open_file = function(file) {
	window.open('/'+file,'_blank');
}

delete_file = function(file) {
   $.post('/rm', {
        'file': file,
   }, function(d) {
	disp_fs();
   }, 'json');

}


disp_fs = function() {
  $(".pages").hide();
  var t = $('#dir_file_list');
  t.empty();
  $.get('/list', {}, function(d) {
	var html;
	for (var i in d) {
		var f = d[i];
		html = '<tr id="f_'+f.name+'"><td class="ta_l"><a href="#" onclick="open_file(\''+f.name+'\'); return false;">'+f.name+
		'</a></td><td>'+f.size+' байт</td><td>'+
		'<a href="#" onclick="delete_file(\''+f.name+'\'); return false;">Удалить</a>'+
		'</td></tr>';
		t.append(html);
	}
	$("#dir_list").show();
	window.location.hash = '#disp_fs';
  }, 'json');
}

_sysinfo = function() {
  $.get('/sysinfo', {}, function(d) {
	$(".Version").html('Версия: '+d.version+'. ');
	$(".usedBytes").html('Использовано: '+d.usedBytes);
	$(".totalBytes").html('Всего: '+d.totalBytes);
	$(".heap").html('heap: '+d.heap);
	$(".rReason").html(d.rReason);
    $('#alarmsound').prop("checked",false);
    if (eval(d.asoundOff)) $('#alarmsound').prop("checked",true);
    
    if (eval(d.no_power)) 
        $('.power').hide();
    else
        $('.power').show();
    
    set_bmd_data(d);
  }, 'json');
}

set_bmd_data = function(d){
    let show = false;
	if (typeof(d.bmpTemperature) != "undefined") {
		$(".bmpTemperature").html(d.bmpTemperature);
        show=true;
	}
	if (typeof(d.bmpTruePressure) != "undefined") {
		$(".bmpTruePressure").html(d.bmpTruePressure);
        show=true;
	}
    if (show) $(".bmpdata").show();
    else $(".bmpdata").hide();
}

do_reset = function() {
  $.get('/r', {}, function(d) {
	window.location.href="/index.html";
  }, 'html');

}

let alarm_sound_off = 0;


$('#alarmsound').click(function(){
    if ($(this).is(':checked')) alarm_sound_off=1;
    else alarm_sound_off=0;
    $.post('/asound', {
            'off': alarm_sound_off
       }, function(d) {
        showStick(d.err, d.msg);
      }, 'json');
});

$(document).ready(function() {
  var h = window.location.hash;
  var u = geturlpath();
  $(".pages").hide();
  _sysinfo();

  switch(h) {
  case '#net_setup':
	disp_network();
	break;
  case '#param_setup':
	disp_setting();
	break;
  case '#sens_setup':
	disp_sensor();
	break;
  case '#wifi_setup':
	disp_wifi();
	break;
  case '#disp_fs':
	disp_fs();
	break;
  default:
	disp_main();
	break;
  }
  $("#emuswitch").prop("checked",0);
  if ($('#alarmsound').prop('checked')) alarm_sound_off=1;
  else alarm_sound_off=0;
  websock_init(u[4], 'web');
});

$(window).unload( function () {
  if ('undefined' != typeof WS_SOCK) {
	WS_SOCK.close();
  }
});

const time = $('.timeLastWS');
intervalId = setInterval(timerWSupdate, 1000);

function timerWSupdate() {
  const newTime = eval(time.text()) + 1;
  time.text(newTime);
  if(newTime > 6) {
    ws_status("LOST","red");
  }
  else {
    ws_status("OK","green");
  }
}

telegramTest = function (){
    let token =  $("#tokenTlg").val();
	let chatid = $('#chatidTlg').val();
    if (token !=""){
        $.post('/tlgtest', {
                'token': token,
                'chatid': chatid
           }, function(d) {
            showStick(d.err, d.msg);
          }, 'json');
     }
     else {
        alert("укажите токен");
     }
}

const getFrequency = (note = 1) => {
    switch (note) {
        case 4:
            return 440;
        case 6:
            return 392;
        case 8:
            return 349;
        case 9:
            return 330;
        case 11:
            return 294;
        case 13:
            return 262;
        case 14:
            return 247;
        case 15:
            return 233;
        case 16:
            return 220;
        case 18:
            return 196;
        case 21:
            return 165;
        default:
            return 0;
    }
}

const sleep = (duration = 250) => new Promise((resolve) => {setTimeout(resolve, duration);}
);

let context = null;

const beep = (freq = 520, duration = 200, vol = 100) => {
    const oscillator = context.createOscillator();
    const gain = context.createGain();
    oscillator.connect(gain);
    oscillator.frequency.value = freq;
    oscillator.type = "square";
    gain.connect(context.destination);
    gain.gain.value = vol * 0.01;
    oscillator.start(context.currentTime);
    oscillator.stop(context.currentTime + duration * 0.001);
}


async function beep_notes(array) {
  context = new AudioContext();
  for (const note of array) {
      await sleep();
      beep(getFrequency(note));
  }
}

const alarm_beep = ()=>{
    const alarmNotes = [4,9];    
    beep_notes(alarmNotes);
}
</script>

</body></html>
